# ===========================================================
# Scout Analytics – Desired End-State Dashboard Specification
# Revision: 2025-06-14-r2
# NOTE: canonical file — overwrite any earlier copies
# ===========================================================

meta:
  dashboard_id: scout-analytics-mvp
  name: "Scout Analytics – Philippine Retail Intelligence"
  route: "/"
  owner: pulser/edge
  status: production-ready
  data_sources:
    - supabase[transactions]
    - supabase[transaction_items]
    - supabase[stores]
    - supabase[products]
    - supabase[customers]
    - supabase[inventory]               # 2025-06-14
    - edge_function[track_event]        # optional
    - edge_function[geocode_address]    # optional
    - edge_function[azure_openai_stream]

layout:
  viewport:
    min_width: 320
    breakpoints: [sm, md, lg, xl]
  grid:
    columns:
      sm: 1
      md: 2
      lg: 3
      xl: 4
    gap: 1rem

# ───────────────────────── Components ───────────────────────

components:

  # KPI ROW --------------------------------------------------

  - id: kpi_total_revenue
    type: kpi
    title: "Total Revenue"
    unit: currency
    format: "₱0,0.00"
    col_span: 1
    sql: |
      SELECT COALESCE(SUM(total_amount),0) AS value
      FROM transactions
      WHERE {{ global_filters }};

    delta:
      basis: prev_28d
      sql: |
        WITH cur AS (
          SELECT SUM(total_amount) v
          FROM transactions
          WHERE transaction_date BETWEEN {{period_start}} AND {{period_end}}
        ),
        prev AS (
          SELECT SUM(total_amount) v
          FROM transactions
          WHERE transaction_date BETWEEN {{period_start_prev}} AND {{period_end_prev}}
        )
        SELECT ROUND( (cur.v-prev.v)/NULLIF(prev.v,0)*100 ,1) AS pct
        FROM cur,prev;

  - id: kpi_transactions
    type: kpi
    title: "Transactions"
    unit: count
    format: "0,0"
    col_span: 1
    sql: |
      SELECT COUNT(*) FROM transactions WHERE {{ global_filters }};
    delta: { basis: prev_28d, sql: "*kpi_total_revenue.delta.sql" }

  - id: kpi_aov
    type: kpi
    title: "Avg Order Value"
    unit: currency
    format: "₱0,0.00"
    col_span: 1
    sql: |
      SELECT COALESCE(AVG(total_amount),0)
      FROM transactions
      WHERE {{ global_filters }};
    delta: { basis: prev_28d, sql: "*kpi_total_revenue.delta.sql" }

  - id: kpi_units_sold
    type: kpi
    title: "Units Sold"
    unit: count
    format: "0,0"
    col_span: 1
    sql: |
      SELECT COALESCE(SUM(ti.quantity),0)
      FROM transaction_items ti
      JOIN transactions t ON t.id = ti.transaction_id
      WHERE {{ global_filters }};
    delta: { basis: prev_28d, sql: "*kpi_total_revenue.delta.sql" }

  - id: kpi_unique_customers
    type: kpi
    title: "Unique Customers"
    unit: count
    format: "0,0"
    col_span: 1
    sql: |
      SELECT COUNT(DISTINCT customer_id)
      FROM transactions
      WHERE {{ global_filters }};
    delta: { basis: prev_28d, sql: "*kpi_total_revenue.delta.sql" }

  - id: kpi_gross_margin_pct
    type: kpi
    title: "Gross Margin %"
    unit: percent
    format: "0.0 %"
    col_span: 1
    sql: |
      WITH x AS (
        SELECT SUM((ti.unit_price-COALESCE(p.unit_cost,0))*ti.quantity) AS gm,
               SUM(t.total_amount)                                     AS rev
        FROM transaction_items ti
        JOIN products p  ON p.id = ti.product_id
        JOIN transactions t ON t.id = ti.transaction_id
        WHERE {{ global_filters }}
      )
      SELECT ROUND(gm/NULLIF(rev,0)*100,1) FROM x;
    delta: { basis: prev_28d, sql: "*kpi_total_revenue.delta.sql" }

  # VISUALS --------------------------------------------------

  - id: chart_revenue_trend
    type: chart
    title: "Revenue Trend (30 days)"
    chart: line
    col_span: 2
    min_height: 18rem
    lazy_load: false
    sql: |
      SELECT DATE(transaction_date) AS label,
             SUM(total_amount)      AS value
      FROM transactions
      WHERE transaction_date >= NOW()-INTERVAL '30 day'
      AND {{ global_filters }}
      GROUP BY 1
      ORDER BY 1;

  - id: chart_category_perf
    type: chart
    title: "Category Performance"
    chart: donut
    col_span: 1
    lazy_load: true
    sql: |
      SELECT p.category AS label,
             SUM(ti.unit_price*ti.quantity) AS value
      FROM transaction_items ti
      JOIN products p ON p.id = ti.product_id
      JOIN transactions t ON t.id = ti.transaction_id
      WHERE {{ global_filters }}
      GROUP BY 1
      ORDER BY value DESC
      LIMIT 6;

  - id: chart_region_dist
    type: chart
    title: "Regional Distribution"
    chart: geo
    col_span: 1
    lazy_load: true
    mobile_fallback: ranked_table
    sql: |
      SELECT s.region AS label,
             SUM(t.total_amount) AS value
      FROM transactions t
      JOIN stores s ON s.id = t.store_id
      WHERE {{ global_filters }}
      GROUP BY 1;

  # AI INSIGHTS ---------------------------------------------

  - id: panel_ai_insights
    type: insight_panel
    title: "AI-Powered Insights"
    datasource: edge_function/azure_openai_stream   # streaming
    props:
      max_items: 3
      show_confidence: true
    col_span: 1

  # DATA QUALITY --------------------------------------------

  - id: panel_data_quality
    type: quality_audit
    title: "Data Quality Audit"
    datasource: view/data_quality_audit
    threshold: 95
    col_span: 2

  # ACTION BOARD -------------------------------------------

  - id: board_action_items
    type: action_board
    title: "Prioritised Actions"
    datasource: table/actions
    columns: [priority, title, impact_estimate, owner, due_date]
    col_span: 2

# ───────────────────────── Filters ─────────────────────────

global_filters:
  date_range: { from: date|null, to: date|null }
  barangays:   string[]
  regions:     string[]
  categories:  string[]
  brands:      string[]
  stores:      string[]